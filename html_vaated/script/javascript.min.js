var statisticsSortBy="name",statisticsSortByDirection="down";
function querydb(a){var b;b="vote"===a.data.url?"/server/GetCandidates":"/server/GetVotes";var c=parseInt($("#politics-party").val(),10),d=parseInt($("#districts").val(),10),f,g,e="";1<=c&&1<=d?(g=3,f={party_id:c,region_id:d},e="&party_id="+c+"&region_id="+d):1<=c?(g=2,f={party_id:c},e="&party_id="+c):1<=d?(g=1,f={region_id:d},e="&region_id="+d):(g=1,f={},e="");$("#loading").show();if(!0===navigator.onLine)$.getJSON(b,f,function(b){updateTableContent(b,a,g,e)});else switch(b="",g){case 1:b=JSON.parse(localStorage["region_"+
d]);updateTableContent(b,a,g,e);break;case 2:b=JSON.parse(localStorage["party_"+c]);updateTableContent(b,a,g,e);break;case 3:b=JSON.parse(localStorage["party_"+c+"_region_"+d]),updateTableContent(b,a,g,e)}}function updateTableContent(a,b,c,d){"vote"===b.data.url?updateTable(a,c):updateStatisticsTable(a,c);a=$("#content").html();c=location.href.split("&");history.pushState(a,b.target.textContent,c[0]+d)}
function updateTable(a,b){$(".voting-table tr").remove();var c=generateTHead(b);$(".voting-table thead").append(c);var d="";switch(b){case 3:$(".name").css({width:"80%"});break;case 4:$(".name").css({width:"30%"}),$(".party").css({width:"30%"})}if(4===b)a.candidates.forEach(function(a){d+='<tr class="tbody_tr"><td class="name">'+a.person_name+'</td><td class="party">'+a.party_name+'</td><td class="party">'+a.region_name+'</td><td class="vote"><p class="vote_text" id="vote_'+a.id+'">H\u00e4\u00e4leta</p></td><td class="candidate_id">'+
a.id+"</td></tr>"});else for(c=0;c<a.candidates.length;c++)d+='<tr class="tbody_tr"><td class="name">'+a.candidates[c].person_name+(3===b?"":'</td><td class="party">'+(1===b?a.candidates[c].party_name:a.candidates[c].region_name))+'</td><td class="vote"><p class="vote_text" id="vote_'+a.candidates[c].id+'">H\u00e4\u00e4leta</p></td><td class="candidate_id">'+a.candidates[c].id+"</td></tr>";$("#voting-table-body").append(d);for(c=0;c<a.candidates.length;c++){var f=a.candidates[c].id;$("#vote_"+a.candidates[c].id).click({id:f},
vote)}$("#loading").hide()}function vote(a){a.preventDefault();$.post("/server/private/Vote",JSON.stringify({action:"vote",candidate_id:a.data.id,sura:"sfa"}),function(a){"alreadyVoted"===a.result?alert("Te olete juba h\u00e4\u00e4letanud."):"success"===a.result&&(postToServer(),votedBox(a))})}
function updateStatisticsTable(a,b){$(".voting-table tr").remove();var c=generateStatisticsTHead(b);$(".voting-table thead").empty();$(".voting-table thead").append(c);var d="";switch(b){case 3:$(".name").css({width:"80%"});break;case 4:$(".name").css({width:"30%"}),$(".party").css({width:"30%"})}switch(b){case 4:a.candidates.forEach(function(a){d+='<tr class="tbody_tr"><td class="name">'+a.person_name+'</td><td class="vote"><p class="vote_text">'+a.vote+"</p></td></tr>"});break;case 3:for(c=0;c<
a.candidates.length;c++)d+='<tr class="tbody_tr"><td class="name">'+a.candidates[c].person_name+'</td><td class="vote">'+a.candidates[c].vote+"</td></tr>";break;case 2:for(c=0;c<a.candidates.length;c++)d+='<tr class="tbody_tr"><td class="name">'+a.candidates[c].person_name+'</td><td class="vote">'+a.candidates[c].vote+"</td></tr>";break;case 1:for(c=0;c<a.partys.length;c++)d+='<tr class="tbody_tr"><td class="name">'+a.partys[c].name+'</td><td class="vote">'+a.partys[c].votes+"</td></tr>";break;case 0:for(c=
0;c<a.partys.length;c++)d+='<tr class="tbody_tr"><td class="name">'+a.partys[c].name+'</td><td class="vote">'+a.partys[c].votes+"</td></tr>"}$("#voting-table-body").append(d);$($(".name")[0]).bind("click",sortButtonClick);$($(".vote")[0]).bind("click",sortButtonClick);sortStatistics($(".name")[0]);$("#loading").hide()}
function generateTHead(a){var b="";switch(a){case 1:b='<tr><th class="name">Nimi</th><th class="party">Erakond</th><th class="vote">H\u00e4\u00e4leta</th><th class="candidate_id"></th></tr>';break;case 2:b='<tr><th class="name">Nimi</th><th class="party">Maakond</th><th class="vote">H\u00e4\u00e4leta</th><th class="candidate_id"></th></tr>';break;case 3:b='<tr><th class="name">Nimi</th><th class="vote">H\u00e4\u00e4leta</th><th class="candidate_id"></th></tr>';break;case 4:b='<tr><th class="name">Nimi</th><th class="party">Erakond</th><th class="party">Maakond</th><th class="vote">H\u00e4\u00e4leta</th><th class="candidate_id"></th></tr>'}return b}
function generateStatisticsTHead(a){var b="";0===a&&(a=1);switch(a){case 1:b='<tr><th class="name">Erakond&#x25B2</th><th class="vote">H\u00e4\u00e4led</th>';break;case 2:b='<tr><th class="name">Nimi&#x25B2</th><th class="vote">H\u00e4\u00e4led</th>';break;case 3:b='<tr><th class="name">Nimi&#x25B2</th><th class="vote">H\u00e4\u00e4led</th>';break;case 4:b='<tr><th class="name">Nimi&#x25B2</th><th class="vote">H\u00e4\u00e4led</th>'}return b}
function navigation(a){var b=a.target.href.split("?"),c=b[1].split(/=|&/)[1],d=getFileNameByPageParam(c);$("#loading").show();$.get(d,function(c){c=updateContent(c,d,b[1]);history.pushState(c,a.target.textContent,a.target.href)})}
function getFileNameByPageParam(a){var b="";switch(a){case "index":b="index.html";break;case "vote":b="h22letamine.html";break;case "nominate":b="kandideerimine.html";break;case "list":b="nimekiri.html";break;case "statistics":b="statistika.html";break;case "kkk":b="kkk.html"}return b}function search_h(a){var b=$("#search-candidate").val();(a||!(2>b.length))&&$.getJSON("/server/GetCandidates",{letters:b},function(a){updateTable(a,4)})}
function search(a,b){var c=$("#search-candidate").val();if(a||!(2>c.length))if(!0===navigator.onLine)$.getJSON("/server/GetVotes",{letters:c},function(a){updateLetterSearch(a,4,c,b)});else{var d=JSON.parse(localStorage.all_votes),f=[],g=RegExp("^"+c,"i");d.candidates.forEach(function(a){var b=a.person_name.split(" ");b.unshift(b.pop());b=b.join(" ");g.test(b)&&f.push({person_name:a.person_name,vote:a.vote})});updateLetterSearch({candidates:f},4,c,b)}}
function updateContent(a,b,c){if(null!==a){var d="",f="",g="";c=c.split("&");if(1<c.length)for(var e=0;e<c.length;e++){var h=c[e].indexOf("=");-1!==c[e].indexOf("party_id")?g=c[e].substr(h+1):-1!==c[e].indexOf("region_id")?f=c[e].substr(h+1):-1!==c[e].indexOf("letters")&&(d=c[e].substr(h+1))}$("#content").empty();if("index.html"===b)$("#content").append("<h1>H\u00e4\u00e4letamise hetkeseis</h1><div id='googleMap'></div><div id='legend'><h3>Legend</h3></div>"),initialize(),$("#loading").hide();else{if("h22letamine.html"===
b||"kandideerimine.html"===b){var k=!1;jQuery.ajaxSetup({async:!1});$.getJSON("/server/private/VerifyLogin",function(a){k="success"===a.result?!0:!1});jQuery.ajaxSetup({async:!0});if(!1===k){$("#content").append("<b> Ainult autentinud kasutajatele</b>");$("#loading").hide();return}}$("#content").append(a);if("h22letamine.html"===b||"kandideerimine.html"===b||"statistika.html"===b)!0===navigator.onLine?($.ajaxSetup({async:!1}),$.getJSON("/server/GetRegions",function(a){localStorage.setItem("regions",
JSON.stringify(a));setRegions(a)}),$.getJSON("/server/GetPartys",function(a){localStorage.setItem("partys",JSON.stringify(a));setPartys(a)}),$.ajaxSetup({async:!0})):(a=JSON.parse(localStorage.regions),c=JSON.parse(localStorage.partys),setRegions(a),setPartys(c));if("h22letamine.html"===b)$("#search-candidate").keypress(function(a){13===a.which&&a.preventDefault()}),$("#search-candidate").keyup(function(a){clearTimeout($.data(this,"timer"));13===a.keyCode?search_h(!0):$(this).data("timer",setTimeout(search_h,
500))}),$("#districts").bind("change",{url:"vote"},querydb),$("#politics-party").bind("change",{url:"vote"},querydb),$.getJSON("/server/private/Vote",function(a){$("#is_voted_text").empty();"alreadyVoted"===a.result?votedBox(a):notVotedBox()});else if("statistika.html"===b){$("#search-candidate").keypress(function(a){13===a.which&&a.preventDefault()});$("#search-candidate").keyup(function(a){clearTimeout($.data(this,"timer"));13===a.keyCode?search(!0,a):$(this).data("timer",setTimeout(function(){search(!1,
a)},500))});$("#districts").bind("change",{url:"random"},querydb);$("#politics-party").bind("change",{url:"random"},querydb);""===g&&(""===f&&""===d)&&$.getJSON("/server/GetVotes",function(a){updateStatisticsTable(a,0)});"https:"!==window.location.protocol&&(b=new WebSocket("ws://veebimaailm.dyndns.info/server/VotesUpdate","echo-protocol"),b.onopen=function(){},b.onmessage=function(){$("#politics-party").change()});b=document.getElementsByTagName("script");a=!1;for(c=0;c<b.length;c++)if(-1!==b[c].src.indexOf("script/votesDownloader.js")){a=
!0;break}a||downloadJSAtOnload("script/votesDownloader.js")}else if("kandideerimine.html"===b){$("#districts").bind("change",hideSelectionError);$("#politics-party").bind("change",hideSelectionError);$("#candidate_questionary").submit(valitadeQuestionary);$.getJSON("/server/private/Nominate",function(a){$("#is_voted_text").empty();"alreadyNominated"===a.result?nominatedBox(a):notNominatedBox()});b=document.getElementsByTagName("script");a=!1;for(c=0;c<b.length;c++)if(-1!==b[c].src.indexOf("script/jquery-ui.min.js")){a=
!0;break}a||downloadJSAtOnload("script/jquery-ui.min.js")}""!==g&&$("#politics-party").val(g);""!==f&&$("#districts").val(f);""!==d&&$("#search-candidate").val(d);""!==g?$("#politics-party").change():""!==f?$("#districts").change():""!==d&&$("#search-candidate").keyup();$("#loading").hide();return $("#content").html()}}}
function votedBox(a){var b=new Date(a.timestamp);a=b.getDate();var c=("0"+(b.getMonth()+1)).slice(-2),b=b.getFullYear();a="["+a+"."+c+"."+b+"]";$("#is_voted_text").html("Te olete juba h\u00e4\u00e4letanud."+a+"<br/><br/><a href='h22letamine.html' id='cancel_vote'>T\u00fchista h\u00e4\u00e4l</a>");$(".is_voted_for").css({background:"#006600"});$("#cancel_vote").click(function(a){a.preventDefault();$.post("/server/private/Vote",JSON.stringify({action:"cancel"}),function(a){"success"===a.result?(notVotedBox(),
postToServer()):alert("Esines t\u00f5rge: V\u00f5imalik, et olete juba oma h\u00e4\u00e4le t\u00fchistanud v\u00f5i on sessioon aegunud.Proovige lehte uuesti laadida")})})}function notVotedBox(){$(".is_voted_for").css({background:"#ff7b2b"});$("#is_voted_text").html("Te ei ole veel h\u00e4\u00e4letanud.")}function notNominatedBox(){$(".is_applyed_for").css({background:"#ff7b2b"});$("#is_voted_text").html("Te ei ole veel kandideerinud.")}
function nominatedBox(a){if("undefined"===typeof a.party||"undefined"===typeof a.region)a.party=$("#politics-party :selected").text(),a.region=$("#districts :selected").text();$("#is_voted_text").html("Te olete kandideerinud.<br/><br/>Piirkond: "+a.region+"<br/><br/>Erakond: "+a.party+"<br/><br/><a href='kandideerimine.html' id='cancel_nominate'>T\u00fchista kandideerimine</a>");$(".is_applyed_for").css({background:"#006600","margin-right":"40%"});$("#cancel_nominate").click(function(a){a.preventDefault();
$.post("/server/private/Nominate",JSON.stringify({action:"cancel"}),function(a){"success"===a.result?(notNominatedBox(),postToServer()):alert("Esines t\u00f5rge: V\u00f5imalik, et olete juba oma kandideerimise t\u00fchistanud v\u00f5i on sessioon aegunud.Proovige lehte uuesti laadida")})})}function updateLetterSearch(a,b,c,d){updateStatisticsTable(a,b);a=$("#content").html();b=location.href.split("&");history.pushState(a,d.target.textContent,b[0]+("&letters="+c))}
function setRegions(a){$("#districts").empty();$("#districts").append(new Option("Vali piirkond",0));a.regions.forEach(function(a){$("#districts").append(new Option(a.name,a.id_region))})}function setPartys(a){$("#politics-party").empty();$("#politics-party").append(new Option("Vali erakond",0));a.partys.forEach(function(a){$("#politics-party").append(new Option(a.name,a.id_party))})}
function postToServer(){jQuery.ajaxSetup({async:!1});$.post("/server/VotesUpdate",{action:"vote"},function(){});jQuery.ajaxSetup({async:!0})}
function valitadeQuestionary(a){var b=parseInt($("#politics-party").val(),10),c=parseInt($("#districts").val(),10);0===c&&$("#nodistrictselectederror").show();0===b&&$("#nopartyselectederror").show();if(0===b||0===c)a.preventDefault();else{a=$("#districts").find(":selected").text();var d=$("#politics-party").find(":selected").text();$("h1").after('<div id="dialog-confirm"></div>');$("#dialog-confirm").attr("title","Kandideerimine");$("#dialog-confirm").html("Piirkond: "+a+"<br/>Erakond: "+d+"<br/>Kas soovite kandideerida?");
$("#dialog-confirm").dialog({resizable:!1,modal:!0,buttons:{Jah:function(){applyFor(b,c);$(this).dialog("close")},Ei:function(){$(this).dialog("close")}}})}return!1}function applyFor(a,b){$.post("/server/private/Nominate",JSON.stringify({action:"nominate",region_id:b,party_id:a}),function(a){"success"===a.result?(postToServer(),nominatedBox(a)):"alreadyNominated"===a.result&&alert("Te olete juba kandideerinud.")})}
function hideSelectionError(a){var b=parseInt($(a.target).find(":selected").val(),10);a=$(a.target).attr("id");0!==b&&("districts"===a?$("#nodistrictselectederror").hide():$("#nopartyselectederror").hide());return!1}function sortButtonClick(a){sortStatistics(a.target);return a.preventDefault()}
function sortStatistics(a){var b="";if(a.className===statisticsSortBy)b=a.innerHTML.slice(0,-1),"up"===statisticsSortByDirection?(statisticsSortByDirection="down",a.innerHTML=b+"&#x25BC"):(statisticsSortByDirection="up",a.innerHTML=b+"&#x25B2");else{var b=a.innerHTML,c=$("."+statisticsSortBy)[0].innerHTML.slice(0,-1);$("."+statisticsSortBy)[0].innerHTML=c;a.innerHTML=b+"&#x25B2";statisticsSortByDirection="up"}statisticsSortBy=a.className;a=$("#voting-table-body tr");if("vote"===statisticsSortBy)"down"===
statisticsSortByDirection?a.sort(reverseNumberColumn):a.sort(sortNumberColumn);else if("name"===statisticsSortBy||"party"===statisticsSortBy)"down"===statisticsSortByDirection?a.sort(reverseNameColumn):a.sort(sortNameColumn);$("#voting-table-body").empty();$("#voting-table-body").append(a)}function sortNameColumn(a,b){var c=$(a).children(".name").text().split(" ")[1],d=$(b).children(".name").text().split(" ")[1];return c>d?1:c<d?-1:0}
function reverseNameColumn(a,b){var c=$(a).children(".name").text().split(" ")[1],d=$(b).children(".name").text().split(" ")[1];return c<d?1:c>d?-1:0}function sortNumberColumn(a,b){var c=parseInt($(a).children(".vote").text(),10),d=parseInt($(b).children(".vote").text(),10);return c-d}function reverseNumberColumn(a,b){var c=parseInt($(a).children(".vote").text(),10);return parseInt($(b).children(".vote").text(),10)-c}
function downloadJSAtOnload(a){var b=document.createElement("script");b.src=a;document.body.appendChild(b)};var timeout=null;
$(document).ready(function(){$(".js-include").each(function(){var a=$(this);"undefined"===typeof $("#header")[0]&&$.get(a.attr("title"),function(b){a.replaceWith(b);b=document.getElementsByClassName("headerlink");for(var c=0;c<b.length;c++){$(b[c]).bind("click",linkClicked);var d=$(b[c]).attr("href").split("?")[1].split("=")[1],f=location.href.split("?")[1].split("=")[1].split("&");d===f[0]&&$(b[c]).trigger("click",location.href)}generateloginbox()})});window.addEventListener("popstate",function(a){var b=
a.target.location.href,c="";""!==b&&(c=b.split("?")[1],b=getFileNameByPageParam(c.split(/=|&/)[1]));updateContent(a.state,b,c);clearTimeout(timeout);timeout=setTimeout(function(){},50)})});function linkClicked(a,b){a.preventDefault();"undefined"!==typeof b&&(a.target.href=b);navigation(a);$(".activetab").removeClass("activetab");$(a.target).addClass("activetab");return!1}
function generateloginbox(){"https:"!==window.location.protocol?generateNotLogedIn():$.getJSON("/server/private/VerifyLogin",function(a){$("#login").empty();"success"===a.result?(a='<form action="/server/private/VerifyLogin" id="loginform" method="post" accept-charset="utf-8"><div id="namefield"> Nimi: <b>'+a.username+'</b></div><input type="submit" name="Submit" value="Logi V\u00e4lja"><br/></form>',$("#login").append(a),$("#loginform").submit(function(a){a.preventDefault();$.post("/server/private/VerifyLogin",
{logout:5433},function(){"http:"!==window.location.protocol&&(window.location.href=window.location.href.replace("https","http"))})})):generateNotLogedIn()})}
function generateNotLogedIn(){$("#login").empty();$("#login").append("<p>Logi sisse ID-kaardiga</p><a href='#' id='loginlink'><img width='88' height='31' src='images/idkaart.gif' alt='Sisse logimine' title='Sisse logimiseks tuleb vajutada v\u00e4hemalt 2 korda id kaardi pildil. ID-kaart peab olema juba lugejas.  Esimest korda suunatakse https-lehele ning alles teisel korral alles toimub reaalne sisselogimine.'/>");$("#loginlink").bind("click",login)}
function login(){"https:"!==window.location.protocol?window.location.href=window.location.href.replace("http","https"):($.post("/server/private/VerifyLogin",{login:!0},function(a){"success"===a.result?window.location.reload():alert(a.error_code)}),event.preventDefault())};function initialize(){var a={center:new google.maps.LatLng(58.7682,25.266723),zoom:8,mapTypeId:google.maps.MapTypeId.ROADMAP},a=new google.maps.Map(document.getElementById("googleMap"),a);jQuery.ajaxSetup({async:!1});var b=getPartys(),c="";$.getJSON("/server/GetRegions",function(a){c=a.regions});jQuery.ajaxSetup({async:!0});addMarkers(a,b,c);createLegend(a,b)}
function addMarkers(a,b,c){c.forEach(function(c,f){f+=1;var g=[{votes:-1}],e=0;jQuery.ajaxSetup({async:!1});$.getJSON("/server/GetVotes",{region_id:f},function(a){g=a.partys[0];a.partys.forEach(function(a){e+=a.votes})});jQuery.ajaxSetup({async:!0});var h=new google.maps.LatLng(c.latitude,c.longitude),k=getMarkerImageByPartyName(g.name,b);new google.maps.Marker({position:h,map:a,icon:k});0===e&&(e=1);k="<div class='infowindow'>Juhtiv erakond: "+g.name+" H\u00e4\u00e4li protsentuaalselt: "+(100*g.votes/
e).toFixed(1)+"%</div>";addInfoWindow(a,k,h)})}function getPartys(){var a;$.getJSON("/server/GetPartys",function(b){a=b.partys});a.forEach(function(b){var c=getColorByPartyName(b.name,a);b.markerimage=new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|"+c,new google.maps.Size(21,34),new google.maps.Point(0,0),new google.maps.Point(10,34))});return a}
function getColorByPartyName(a,b){var c="FFFFFF";b.forEach(function(b){b.name===a&&(c=b.color)});return c}function getMarkerImageByPartyName(a,b){var c="";b.forEach(function(b){b.name===a&&(c=b.markerimage)});return c}
function addInfoWindow(a,b,c){b={content:b,boxStyle:{border:"1px solid black",textAlign:"center",fontSize:"8pt",width:"100px",background:"#fff"},disableAutoPan:!0,pixelOffset:new google.maps.Size(-25,0),position:c,closeBoxURL:"",isHidden:!1,pane:"mapPane",enableEventPropagation:!0};(new InfoBox(b)).open(a)}
function createLegend(a,b){var c=document.getElementById("legend");b.forEach(function(a){$("#legend").append('<div><img src="'+a.markerimage.url+'"> '+a.name+"</div>")});a.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(c)};
